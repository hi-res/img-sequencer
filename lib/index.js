// Generated by CoffeeScript 1.6.3
var Pivot, Sequencer, Utils, _ref, _ref1,
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
  __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
  __slice = [].slice;

if ((typeof exports !== "undefined" && exports !== null) && module && module.exports) {
  Pivot = require('the-pivot');
}

if (typeof window !== "undefined" && window !== null) {
  window.requestAnimFrame = (function() {
    return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || function(callback) {
      return window.setTimeout(callback, 1000 / 60);
    };
  })();
}

Sequencer = Sequencer || {};

Sequencer.ImageLoader = (function(_super) {
  __extends(ImageLoader, _super);

  function ImageLoader(path, frame) {
    var img,
      _this = this;
    img = new Image();
    img.src = path;
    if (img.dataset != null) {
      img.dataset.frame = frame;
    } else {
      img.setAttribute('data-frame', frame);
    }
    img.onload = function() {
      return _this.trigger('complete', img);
    };
  }

  return ImageLoader;

})(Pivot);

Sequencer.AbstractPlayer = (function(_super) {
  __extends(AbstractPlayer, _super);

  AbstractPlayer.prototype.pixel_ratio = window.devicePixelRatio;

  AbstractPlayer.prototype.retina = window.devicePixelRatio === 2;

  AbstractPlayer.prototype.chrome = window.navigator.userAgent.toLowerCase().indexOf('chrome') > -1;

  AbstractPlayer.prototype.el = null;

  AbstractPlayer.prototype.current_frame = true;

  AbstractPlayer.prototype.mode = null;

  AbstractPlayer.prototype.cssbackgroundsize = false;

  AbstractPlayer.prototype.dev = true;

  AbstractPlayer.prototype.tag_type = 'div';

  AbstractPlayer.prototype.log = function() {
    var args;
    args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
    if (this.dev) {
      return console.log.apply(console, args);
    }
  };

  function AbstractPlayer(el) {
    this.tick = __bind(this.tick, this);
    this.set_frame = __bind(this.set_frame, this);
    this.set_size = __bind(this.set_size, this);
    this.set_mode = __bind(this.set_mode, this);
    this.load = __bind(this.load, this);
    this._setup = __bind(this._setup, this);
    this._load_images = __bind(this._load_images, this);
    this.log = __bind(this.log, this);
    var animloop,
      _this = this;
    this.el = document.getElementById(el);
    (animloop = function() {
      window.requestAnimFrame(animloop);
      return _this.trigger('tick');
    })();
  }

  /*
  	Load images from the data
  */


  AbstractPlayer.prototype._load_images = function() {
    var ext, file_ext, frame, loaded, loader, on_load_complete, path, total_frames, _i, _j, _len, _ref, _results,
      _this = this;
    this._cache = [];
    loaded = 0;
    total_frames = this.get_total_frames();
    on_load_complete = function(img) {
      var id;
      if (img.dataset != null) {
        id = img.dataset.frame;
      } else {
        id = img.getAttribute('data-frame');
      }
      _this._cache[id] = img;
      if (loaded === total_frames) {
        _this._setup();
      }
      return loaded++;
    };
    _results = [];
    for (frame = _i = 0; 0 <= total_frames ? _i <= total_frames : _i >= total_frames; frame = 0 <= total_frames ? ++_i : --_i) {
      file_ext = this.data.extensions[0];
      if (this.chrome) {
        _ref = this.data.extensions;
        for (_j = 0, _len = _ref.length; _j < _len; _j++) {
          ext = _ref[_j];
          if (ext === 'webp') {
            file_ext = ext;
          }
        }
      }
      path = this.path + '/' + frame + '.' + file_ext;
      loader = new Sequencer.ImageLoader(path, frame);
      _results.push(loader.on('complete', on_load_complete));
    }
    return _results;
  };

  /*
  	Setup the container
  */


  AbstractPlayer.prototype._setup = function() {
    var el, height, i, img, scale, width, _i, _len, _ref;
    this.container = document.createElement('div');
    this.container.style.position = 'absolute';
    this.el.appendChild(this.container);
    scale = (this.retina === true ? 0.5 : 1);
    width = this.data.frame.width * scale;
    height = this.data.frame.height * scale;
    this._frames = [];
    _ref = this._cache;
    for (i = _i = 0, _len = _ref.length; _i < _len; i = ++_i) {
      img = _ref[i];
      if (this.cssbackgroundsize) {
        el = document.createElement('div');
        el.style.position = 'absolute';
        el.style.width = '100%';
        el.style.height = '100%';
        el.style.backgroundImage = "url(" + img.src + ")";
        el.style.backgroundRepeat = "no-repeat";
        el.style.visibility = 'hidden';
      } else {
        img.style.position = 'absolute';
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.visibility = 'hidden';
        this.tag_type = 'img';
        el = img;
      }
      this._frames.push(el);
      this.container.appendChild(el);
    }
    this._cache = null;
    this.set_size(width, height);
    return this.trigger('setup_complete', this);
  };

  /*
  	Validate the new frame
  	@return [Int]
  */


  AbstractPlayer.prototype._validate_frame = function() {
    var frame;
    frame = this.mode.get_frame();
    if (frame < 0) {
      this._frame = 0;
      console.warn('Frame is less than 0');
      return this.stop();
    } else if (frame > this.get_total_frames()) {
      this._frame = this.get_total_frames();
      console.warn("Frame is greater than total frames, stopping at " + (this.get_total_frames()));
      return this.stop();
    }
  };

  /*----------------------------------------------
  	@public
  */


  AbstractPlayer.prototype.load = function(path, frames) {
    var _this = this;
    this.path = path;
    return $.ajax({
      url: this.path + '/' + frames,
      complete: function(data) {
        _this.data = JSON.parse(data.responseText);
        return _this._load_images();
      },
      error: function(error) {}
    });
  };

  AbstractPlayer.prototype.noload = function(data, frames) {
    var i, img, _i, _len, _ref;
    this.data = data;
    this._cache = [];
    _ref = frames.images;
    for (i = _i = 0, _len = _ref.length; _i < _len; i = ++_i) {
      img = _ref[i];
      this._cache[i] = img.tag;
    }
    return this._setup();
  };

  /*
  	Set the playback mode
  */


  AbstractPlayer.prototype.set_mode = function(mode) {
    var _ref;
    if ((_ref = this.mode) != null) {
      _ref.off('complete', this.stop);
    }
    this.mode = mode;
    return this.mode.on('complete', this.stop);
  };

  AbstractPlayer.prototype.set_size = function(width, height) {
    var $frames;
    this.width = width;
    this.height = height;
    this.el.style.width = this.width + 'px';
    this.el.style.height = this.height + 'px';
    this.container.style.width = this.el.style.width;
    this.container.style.height = this.el.style.height;
    $frames = $(this.container).find(this.tag_type);
    return Utils.resize($frames, this.data.frame.width, this.data.frame.height, this.width, this.height, this.cssbackgroundsize);
  };

  AbstractPlayer.prototype.set_frame = function(frame) {};

  AbstractPlayer.prototype.tick = function() {
    this.mode.update();
    this._validate_frame();
    return this._update();
  };

  /*
  	Return the number of frames in the sequence
  	@return [Int]
  */


  AbstractPlayer.prototype.get_total_frames = function() {
    return this.data.total_frames - 1;
  };

  AbstractPlayer.prototype.destroy = function() {
    return this.el.innerHTML = '';
  };

  return AbstractPlayer;

})(Pivot);

Sequencer.Player = (function(_super) {
  __extends(Player, _super);

  function Player() {
    this.destroy = __bind(this.destroy, this);
    this.stop = __bind(this.stop, this);
    this.play = __bind(this.play, this);
    this._update = __bind(this._update, this);
    _ref = Player.__super__.constructor.apply(this, arguments);
    return _ref;
  }

  Player.prototype._update = function() {
    var frame;
    frame = this.mode.get_frame();
    if (frame !== this.current_frame) {
      if (this._frames[this.current_frame] != null) {
        this._frames[this.current_frame].style.visibility = 'hidden';
        this._frames[this.current_frame].style.zIndex = 0;
      }
      this.current_frame = frame;
      this._frames[this.current_frame].style.visibility = 'visible';
      return this._frames[this.current_frame].style.zIndex = 1;
    }
  };

  /*
  	Start playback on the current mode
  */


  Player.prototype.play = function() {
    if (this.mode == null) {
      return console.warn('Error --> Set a playback mode first');
    } else {
      return this.on('tick', this.tick);
    }
  };

  /*
  	Stop playback on the current mode
  */


  Player.prototype.stop = function() {
    return this.off('tick', this.tick);
  };

  Player.prototype.destroy = function() {
    this.stop();
    return Player.__super__.destroy.call(this);
  };

  return Player;

})(Sequencer.AbstractPlayer);

Sequencer.Blender = (function(_super) {
  __extends(Blender, _super);

  function Blender() {
    this._update = __bind(this._update, this);
    _ref1 = Blender.__super__.constructor.apply(this, arguments);
    return _ref1;
  }

  Blender.prototype._update = function() {
    var distance, dx, frame, i, normalise, opacity, percent, position, _i, _ref2, _results;
    frame = this.mode.get_frame();
    percent = frame / this.get_total_frames();
    percent = Number(percent.toFixed(2));
    _results = [];
    for (i = _i = 0, _ref2 = this.get_total_frames(); 0 <= _ref2 ? _i <= _ref2 : _i >= _ref2; i = 0 <= _ref2 ? ++_i : --_i) {
      position = i * (1 / this.get_total_frames());
      dx = percent - position;
      distance = Math.sqrt(dx * dx);
      if (distance <= 0.1) {
        normalise = distance * 10;
        opacity = 1 - normalise;
        this._frames[i].style.visibility = 'visible';
        this._frames[i].style.zIndex = 1;
        _results.push(this._frames[i].style.opacity = opacity);
      } else {
        this._frames[i].style.visibility = 'hidden';
        this._frames[i].style.zIndex = 0;
        _results.push(this._frames[i].style.opacity = 0);
      }
    }
    return _results;
  };

  return Blender;

})(Sequencer.AbstractPlayer);

/*----------------------------------------------
Playback modes
*/


/*
Frame mode

Manually set the frame of the sequence
*/


Sequencer.FrameMode = (function(_super) {
  __extends(FrameMode, _super);

  FrameMode.prototype.id = 'FrameMode';

  FrameMode.prototype.frame = 0;

  function FrameMode(data) {
    this.data = data;
  }

  FrameMode.prototype.update = function() {};

  FrameMode.prototype.set_frame = function(frame) {
    this.frame = frame;
  };

  FrameMode.prototype.get_frame = function() {
    return this.frame;
  };

  return FrameMode;

})(Pivot);

/*
Linear mode

Repeats the animation from frame 0 once it reaches the end
*/


Sequencer.LinearMode = (function(_super) {
  __extends(LinearMode, _super);

  LinearMode.prototype.id = 'Linear';

  LinearMode.prototype.frame = 0;

  LinearMode.prototype.speed = 1;

  function LinearMode(data) {
    this.data = data;
  }

  LinearMode.prototype.update = function() {
    return this._set_frame();
  };

  LinearMode.prototype._set_frame = function() {
    if (this.frame >= this.data.total_frames - 1) {
      return this.trigger('complete');
    } else {
      return this.frame += this.speed;
    }
  };

  LinearMode.prototype.get_frame = function() {
    return Math.floor(this.frame);
  };

  return LinearMode;

})(Pivot);

/*
RepeatMode

Repeats the animation from frame 0 once it reaches the end
*/


Sequencer.RepeatMode = (function(_super) {
  __extends(RepeatMode, _super);

  RepeatMode.prototype.id = 'Repeat';

  RepeatMode.prototype.frame = 0;

  RepeatMode.prototype.speed = 1;

  function RepeatMode(data) {
    this.data = data;
  }

  RepeatMode.prototype.update = function() {
    return this._set_frame();
  };

  RepeatMode.prototype._set_frame = function() {
    if (this.frame >= this.data.total_frames - 1) {
      this.frame = 0;
    }
    return this.frame += this.speed;
  };

  RepeatMode.prototype.get_frame = function() {
    return Math.floor(this.frame);
  };

  return RepeatMode;

})(Pivot);

/*
ReverseMode

Plays the animation back and forth
*/


Sequencer.ReverseMode = (function(_super) {
  __extends(ReverseMode, _super);

  ReverseMode.prototype.id = 'Reverse';

  ReverseMode.prototype.frame = 0;

  ReverseMode.prototype.speed = 1;

  function ReverseMode(data) {
    this.data = data;
  }

  ReverseMode.prototype.update = function() {
    return this._set_frame();
  };

  ReverseMode.prototype._set_frame = function() {
    if (this.frame >= this.data.total_frames - 1) {
      this.frame = -Math.abs(this.speed);
    }
    if (this.frame <= 0) {
      Math.abs(this.speed);
    }
    return this.frame += this.speed;
  };

  ReverseMode.prototype.get_frame = function() {
    return Math.floor(this.frame);
  };

  return ReverseMode;

})(Pivot);

/*----------------------------------------------
Utils
*/


Utils = {
  calculate_resize: function(image_width, image_height, win_width, win_height, backgroundsize) {
    var image_ratio1, image_ratio2, new_height, new_left, new_top, new_width, window_ratio;
    window_ratio = win_width / win_height;
    image_ratio1 = image_width / image_height;
    image_ratio2 = image_height / image_width;
    if (window_ratio < image_ratio1) {
      new_height = win_height;
      new_width = new_height * image_ratio1;
      new_top = 0;
      new_left = (win_width * .5) - (new_width * .5);
    } else {
      new_width = win_width;
      new_height = new_width * image_ratio2;
      new_top = (win_height * .5) - (new_height * .5);
      new_left = 0;
    }
    return {
      x: new_left,
      y: new_top,
      width: new_width,
      height: new_height
    };
  },
  /*
  	Resize image(s) to the browser size retaining aspect ratio
  	@param [jQuery]  $images
  	@param [Number]  image_width
  	@param [Number]  image_height
  	@param [Number]  win_width
  	@param [Number]  win_width
  	@param [Boolean] backgroundsize
  */

  resize: function($images, image_width, image_height, win_width, win_height, backgroundsize) {
    var data;
    data = this.calculate_resize(image_width, image_height, win_width, win_height, backgroundsize);
    if (backgroundsize) {
      return $images.css({
        'background-size': "" + data.width + "px " + data.height + "px",
        'background-position': "" + data.x + "px " + data.y + "px"
      });
    } else {
      return $images.css({
        'margin-top': "" + data.y + "px",
        'margin-left': "" + data.x + "px",
        'width': "" + data.width + "px",
        'height': "" + data.height + "px"
      });
    }
  }
};

if ((typeof exports !== "undefined" && exports !== null) && module && module.exports) {
  module.exports = Sequencer;
} else if (window) {
  window.Sequencer = Sequencer;
}
